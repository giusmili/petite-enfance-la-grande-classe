<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Tests unitaires — js/app.js</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .pass { color: #0a7f35; }
    .fail { color: #b00020; }
    .summary { margin-top: 12px; font-weight: 600; }
    .site-header { position: sticky; top: 0; height: 80px; }
    #menu { display: block; }
    #section1 { margin-top: 1000px; height: 200px; background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Tests unitaires — js/app.js</h1>
  <p>Ouvrez cette page dans un navigateur pour exécuter les tests.</p>
  <div id="results"></div>

  <!-- Structure minimale attendue par js/app.js -->
  <header class="site-header"></header>
  <button class="nav-toggle" aria-expanded="false">Menu</button>
  <nav id="menu"></nav>
  <p><a id="go" href="#section1">Aller à la section</a></p>
  <div id="section1">Section 1</div>

  <script>
    // Petit utilitaire de test sans dépendances
    (function () {
      const results = document.getElementById('results');
      let passed = 0, failed = 0;
      function log(ok, msg) {
        const p = document.createElement('p');
        p.className = ok ? 'pass' : 'fail';
        p.textContent = (ok ? '✓ ' : '✗ ') + msg;
        results.appendChild(p);
        ok ? passed++ : failed++;
      }
      function assert(cond, msg) { log(!!cond, msg); }
      function summary() {
        const s = document.createElement('p');
        s.className = 'summary';
        s.textContent = `Résumé: ${passed} passé(s), ${failed} échec(s)`;
        results.appendChild(s);
        document.title = failed === 0 ? 'OK — app.js' : 'KO — app.js';
      }
      window.__test = { assert, summary };
    })();
  </script>

  <!-- Charge le script à tester -->
  <script src="../js/app.js"></script>

  <script>
    (function runTests() {
      const { assert, summary } = window.__test;

      // Mocks et références DOM
      const toggle = document.querySelector('.nav-toggle');
      const menu = document.getElementById('menu');
      const header = document.querySelector('.site-header');
      const link = document.getElementById('go');
      const target = document.getElementById('section1');

      // Test 1: Toggle ouvre/ferme le menu et met à jour aria-expanded
      assert(toggle.getAttribute('aria-expanded') === 'false', 'aria-expanded initial = false');
      toggle.click();
      assert(toggle.getAttribute('aria-expanded') === 'true', 'aria-expanded devient true');
      assert(menu.classList.contains('is-open'), 'menu reçoit la classe is-open');
      assert(document.body.classList.contains('nav-open'), 'body reçoit la classe nav-open');

      toggle.click();
      assert(toggle.getAttribute('aria-expanded') === 'false', 'aria-expanded redevient false');
      assert(!menu.classList.contains('is-open'), 'menu perd la classe is-open');
      assert(!document.body.classList.contains('nav-open'), 'body perd la classe nav-open');

      // Test 2: Click sur une ancre valide déclenche un scroll fluide avec offset header
      // Stub des dimensions pour un résultat déterministe
      Object.defineProperty(header, 'offsetHeight', { value: 80, configurable: true });
      const originalGetRect = target.getBoundingClientRect.bind(target);
      target.getBoundingClientRect = () => ({ top: 300, left: 0, right: 0, bottom: 0, width: 0, height: 0, x: 0, y: 0, toJSON(){} });

      // Spy sur scrollTo
      let lastScrollArgs = null;
      const origScrollTo = window.scrollTo;
      window.scrollTo = (args) => { lastScrollArgs = args; };
      window.scrollY = 200; // simulé

      // Ouvre le menu avant le clic sur l’ancre pour tester la fermeture automatique
      menu.classList.add('is-open');
      toggle.setAttribute('aria-expanded', 'true');

      link.click();

      assert(!!lastScrollArgs, 'scrollTo est appelé');
      assert(lastScrollArgs.behavior === 'smooth', 'scrollTo utilise behavior="smooth"');
      assert(lastScrollArgs.top === 420, 'scrollTo.top prend en compte offset header (420 attendu)');
      assert(!menu.classList.contains('is-open'), 'menu se ferme après clic ancre');
      assert(toggle.getAttribute('aria-expanded') === 'false', 'aria-expanded remis à false après clic ancre');

      // Restaure les stubs
      target.getBoundingClientRect = originalGetRect;
      window.scrollTo = origScrollTo;

      summary();
    })();
  </script>
</body>
</html>

